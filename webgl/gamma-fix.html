<!DOCTYPE html>
<title>gamma fix</title>
<canvas width="200" height="200"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twgl.js/4.23.2/twgl-full.js"
    integrity="sha512-eCsXZZ3wMTH/GSekpKxoFQYBb9MAhxAvMRavPeuozqbHSysVhKOxqF+MjeVPkBX2cdHwHLqgSuTVMaF/LfGytQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
'use strict'
let canvas = document.querySelector('canvas')
let gl = canvas.getContext('webgl2', {
  antialias: false,})
let colors = {}
const pr = console.log

// ------ Draw a sphere to a texture ------

let vs = `#version 300 es
in vec4 position;
void main() {
  gl_Position = position;
}`;
let fs = `#version 300 es
precision mediump float;
out vec4 finalCol;
void main() {
  finalCol = vec4(0, 1, 1, 1);    // cyan sphere
}`;
let pi = twgl.createProgramInfo(gl, [vs, fs])
gl.useProgram(pi.program)
let bi = twgl.primitives.createSphereBufferInfo(gl, 0.6, 4, 4)
twgl.setBuffersAndAttributes(gl, pi, bi)

const targetTexture = twgl.createTexture(gl, {
  mag: gl.NEAREST,
  min: gl.LINEAR,
  src: null,
  width: 200,
  height: 200,
  format: gl.RGBA,
});

const offScreen = true;

if (offScreen) {
  const fb = gl.createFramebuffer();
  gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
  gl.viewport(0, 0, 200, 200);
  gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, targetTexture, 0);
}
gl.clearColor(1,0,0,1)  // red background on the texture
gl.clear(gl.COLOR_BUFFER_BIT)
twgl.drawBufferInfo(gl, bi)
if (!offScreen) {
  hist();
  throw new Error();
}

gl.bindFramebuffer(gl.FRAMEBUFFER, null);

// ------ Send the texture to the screen ------

vs = `#version 300 es
in vec4 position;
in vec2 texcoord;
out vec2 v_texCoord;
void main() {
  v_texCoord = texcoord;
  gl_Position = position;
}`;
// Somehow this gamma correction doesn't remove the dark boundary
// around the sphere.
fs = `#version 300 es
precision mediump float;  // highp doesn't seem to help.
in vec2 v_texCoord;
out vec4 finalColour;
uniform sampler2D s;
float f(float x) {
  return pow(x, 0.4545);   // making the 0.4545 a lot smaller doesn't help.
  //return sqrt(sqrt(x));  // sqrt doesn't help either.
}
void main() {
  vec4 t = texture(s, v_texCoord);
  finalColour = vec4(f(t.r), f(t.g), f(t.b), 1);
}`;

gl.clearColor(1.0, 0.8, 0.7, 1.0)
gl.clear(gl.COLOR_BUFFER_BIT)

pi = twgl.createProgramInfo(gl, [vs, fs])
gl.useProgram(pi.program)

let arrays = {
    position: { size: 2, data: new Float32Array([ -.9,-1, 1.1,-1, 1.1,1, ]), },
    texcoord: { size: 2, data: [ 0,0, 1,0, 1,1, ], },
}
bi = twgl.createBufferInfoFromArrays(gl, arrays)
twgl.setBuffersAndAttributes(gl, pi, bi)
twgl.drawBufferInfo(gl, bi, gl.TRIANGLES)
hist()

function hist() {
  gl.flush()
  colors = {}
  let pixels = new Uint8Array(4 * canvas.width * canvas.height)
  gl.readPixels(0, 0, canvas.width, canvas.height, gl.RGBA, gl.UNSIGNED_BYTE, pixels)
  let para = document.createElement('p');
  document.body.appendChild(para)
  for (let i=0; i < pixels.length; i +=4) {
    let color = ''
    for (let j=0; j < 3; j++) {
      color += pixels[i+j] + ', '
    }
    if (colors[color]) {
      colors[color]++
    }
    else {
      colors[color] = 1
    }
  }
  for (let c in colors) {
    let msg = c + ' --- ' + colors[c]
    pr(msg)
    para.insertAdjacentHTML('beforeend', msg + '<br>')
  }
}

</script>
