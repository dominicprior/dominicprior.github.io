<!DOCTYPE html>
<title>render to texture</title>
<canvas width="200" height="200"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twgl.js/4.23.2/twgl-full.js"
    integrity="sha512-eCsXZZ3wMTH/GSekpKxoFQYBb9MAhxAvMRavPeuozqbHSysVhKOxqF+MjeVPkBX2cdHwHLqgSuTVMaF/LfGytQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
// 
'use strict'
const gl = document.querySelector('canvas').getContext('webgl2')
gl.clearColor(0.8, 0.9, 1, 1)
gl.clear(gl.COLOR_BUFFER_BIT)

let vs = `#version 300 es
in vec3 position;
void main() {
    gl_Position = vec4(position, 1);
}`
let fs = `#version 300 es
precision mediump float;
out vec4 finalCol;
void main() {
    finalCol = vec4(1,0,0,1);
}`
let pi = twgl.createProgramInfo(gl, [vs, fs])
gl.useProgram(pi.program)
let bi = twgl.primitives.createSphereBufferInfo(gl, 0.5, 4, 4)
twgl.setBuffersAndAttributes(gl, pi, bi)

const targetTexture = twgl.createTexture(gl, {
  mag: gl.NEAREST,
  min: gl.LINEAR,
  src: null,
  width: 200,
  height: 200,
  format: gl.RGBA,
});

const fb = gl.createFramebuffer();
gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
gl.viewport(0, 0, 200, 200);
gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, targetTexture, 0);
twgl.drawBufferInfo(gl, bi)

gl.bindFramebuffer(gl.FRAMEBUFFER, null);

// ------

vs = `#version 300 es
in vec4 position;  // These two names are chosen
in vec2 texcoord;  // by the twgl primitives.
out vec2 v_texCoord;
void main() {
  v_texCoord = texcoord;
  gl_Position = position.zxyw;
}`;

fs = `#version 300 es
precision mediump float;
in vec2 v_texCoord;
out vec4 finalColour;
uniform sampler2D s;
void main() {
  finalColour = texture(s, v_texCoord);
}`;

gl.clearColor(1.0, 0.8, 0.7, 1.0)
gl.clear(gl.COLOR_BUFFER_BIT)

pi = twgl.createProgramInfo(gl, [vs, fs])
gl.useProgram(pi.program)

//gl.bindTexture(gl.TEXTURE_2D, targetTexture);
//gl.viewport(0, 0, 200, 200);

//////// this is what drawObjectList seemed to do (twice, one for each attribute) ///////////
//gl.bindBuffer(ARRAY_BUFFER, b.buffer);
//gl.enableVertexAttribArray(index);
//gl.vertexAttribPointer(index, b.numComponents || b.size, b.type || FLOAT, b.normalize || false, b.stride || 0, b.offset || 0);
////////

//gl.bindBuffer(ELEMENT_ARRAY_BUFFER, buffers.indices);  // I'm not sure how drawObjectList works without this call

bi = twgl.primitives.createPlaneBufferInfo(gl)

// twgl.drawBufferInfo(gl, bi)  // doesn't work!  drawObjectList must be doing something extra!

let drawObjects = [{
  programInfo: pi,
  bufferInfo: bi,
}];
twgl.drawObjectList(gl, drawObjects);

const pr = console.log

function f() {
  const params = 'VERTEX_ATTRIB_ARRAY_BUFFER_BINDING VERTEX_ATTRIB_ARRAY_ENABLED VERTEX_ATTRIB_ARRAY_SIZE VERTEX_ATTRIB_ARRAY_STRIDE VERTEX_ATTRIB_ARRAY_TYPE VERTEX_ATTRIB_ARRAY_NORMALIZED CURRENT_VERTEX_ATTRIB'.split(' ')
  for (let i of [0,1]) {
    pr(params.map(p => gl.getVertexAttrib(i, gl[p])))
  }
}

f()
// After drawObjectList:
// [WebGLBuffer, true, 3, 0, 5126, false, Float32Array(4)]
// [WebGLBuffer, true, 2, 0, 5126, false, Float32Array(4)]

// After drawBufferInfo:
// [WebGLBuffer, true, 3, 0, 5126, false, Float32Array(4)]
// [null, false, 4, 0, 5126, false, Float32Array(4)]

</script>
