
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>tractrix</title>
</head>
<body>
<div id="paper1"></div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.2/raphael-min.js"></script>
<script>
const paper_w = 1600;
const paper_h = 900;
const rodLen = 200;
const rad = 20;
const acc = 12500;  // pixels / sec / sec
const frameDuration = 0.01;  // in seconds
var paper;
var blobs = new Array();
var textId;
var headId;
var tailId;
var strutId;
var newPos;  // for the whole transition
var prevPos; // for the whole transition
var framePos;
var tailPos;
var totalDuration;  // of the animation in seconds
var numFrames;
var frameNum;
var intervalHandle;
var moving = false;



function Vec(x,y) {
    this.x = x;
    this.y = y;
    this.add = function(v) {
        return new Vec(this.x + v.x, this.y + v.y);
    }
    this.sub = function(v) {
        return new Vec(this.x - v.x, this.y - v.y);
    }
    this.dot = function(v) {
        return this.x * v.x + this.y * v.y;
    }
    this.len = function() {
        return Math.sqrt(this.dot(this));
    }
    this.times = function(k) {
        return new Vec(this.x * k, this.y * k);
    }
    this.div = function(k) {
        return new Vec(this.x / k, this.y / k);
    }
}

function weightedAverage(t, u, v) {
    return v.times(t).add(u.times(1-t));
}

// Gives a uniform acceleration until t = 0.5 and then a uniform deceleration.
function transitionFn(t) {
    // return t < 0.5 ? 2*t*t : 1 - 2*(1-t)*(1-t);
    return t;
}

function repaint(headPos) {
    headId.attr({cx: headPos.x, cy: paper_h - headPos.y});
    tailId.attr({cx: tailPos.x, cy: paper_h - tailPos.y});
    strutId.attr({path: ['M', headPos.x, paper_h - headPos.y,
                         'L', tailPos.x, paper_h - tailPos.y]});
}

// Returns a new tail position that is moved towards (or away from) the head.
function tractrixStep(head, tail) {
    const v = tail.sub(head);
    return head.add(v.times(rodLen / v.len()));
}

// Returns a new tail that is a numerical approximation to the true tractrix position.
function tractrix(oldHead, newHead, tail) {
    const numSteps = 10;
    const step = newHead.sub(oldHead).div(numSteps);
    var head = oldHead;
    for (var i=0; i < numSteps; i++) {
        head = head.add(step);
        tail = tractrixStep(head, tail);
    }
    return tail;
}

function clickFn(e) {
    if (moving)
        return;
    prevPos = newPos;
    newPos = new Vec(e.offsetX, paper_h - e.offsetY);
    if (textId) {
        textId.remove();
        textId = 0;
    }
    var segmentLen = newPos.sub(prevPos).len();
    totalDuration = 2 * Math.sqrt(segmentLen / acc);
    numFrames = Math.ceil(totalDuration / frameDuration);
    if (numFrames == 0)
        return;  // because the click was too near
    frameNum = 0;
    framePos = prevPos;
    moving = true;
    intervalHandle = setInterval(timerFn, frameDuration * 1000);
}

function timerFn() {
    frameNum++;
    var timeProportion = frameNum / numFrames;
    var posProportion = transitionFn(timeProportion);
    var prevFramePos = framePos;
    framePos = weightedAverage(posProportion, prevPos, newPos);
    tailPos = tractrix(prevFramePos, framePos, tailPos);
    repaint(framePos);
    if (frameNum == numFrames) {
        clearInterval(intervalHandle);
        moving = false;
    }
}

$(document).ready(function() {
    paper = Raphael("paper1", paper_w, paper_h);
    paper.rect(0, 0, paper_w, paper_h).attr({fill: "#FFD", "stroke-width": 0}).click(clickFn);
    textId = paper.text(paper_w / 2, paper_h / 2, "click anywhere");
    newPos  = new Vec(400, 200);
    tailPos = new Vec(200, 200);
    headId = paper.circle(newPos.x, paper_h - newPos.y, rad);
    headId.attr({fill: 'pink', 'stroke-width': 0});
    tailId = paper.circle(tailPos.x, paper_h - tailPos.y, rad);
    tailId.attr({fill: 'cyan', 'stroke-width': 0});
    strutId = paper.path();
    repaint(newPos);
});
</script>
</body>
</html>
